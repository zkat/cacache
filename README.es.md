# cacache [![npm version](https://img.shields.io/npm/v/cacache.svg)](https://npm.im/cacache) [![license](https://img.shields.io/npm/l/cacache.svg)](https://npm.im/cacache) [![Travis](https://img.shields.io/travis/zkat/cacache.svg)](https://travis-ci.org/zkat/cacache) [![AppVeyor](https://ci.appveyor.com/api/projects/status/github/zkat/cacache?svg=true)](https://ci.appveyor.com/project/zkat/cacache) [![Coverage Status](https://coveralls.io/repos/github/zkat/cacache/badge.svg?branch=latest)](https://coveralls.io/github/zkat/cacache?branch=latest)

[`cacache`](https://github.com/zkat/cacache) es una librer√≠a de Node.js para manejar caches locales en disco, con acceso tanto con claves √∫nicas como direcciones de contenido (hashes). Es s√∫per r√°pida, excelente con el acceso concurrente, y jam√°s te dar√° datos incorrectos, a√∫n si se corrompen o manipulan directamente los ficheros del cache.

El prop√≥sito original era reemplazar el cach√© local de [npm](https://npm.im/npm), pero se puede usar por su propia cuenta.

_Traducciones: [English](README.md)_

## Instalaci√≥n

`$ npm install --save cacache`

## √çndice

* [Ejemplo](#ejemplo)
* [Caracter√≠sticas](#caracter√≠sticas)
* [C√≥mo Contribuir](#c√≥mo-contribuir)
* [API](#api)
  * Leer
    * [`ls`](#ls)
    * [`ls.stream`](#ls-stream)
    * [`get`](#get-data)
    * [`get.stream`](#get-stream)
    * [`get.info`](#get-info)
    * [`get.hasContent`](#get-hasContent)
  * Escribir
    * [`put`](#put-data)
    * [`put.stream`](#put-stream)
    * [`put*` opts](#put-options)
    * [`rm.all`](#rm-all)
    * [`rm.entry`](#rm-entry)
    * [`rm.content`](#rm-content)
  * Utilidades
    * [`setLocale`](#set-locale)
    * [`clearMemoized`](#clear-memoized)
    * [`tmp.mkdir`](#tmp-mkdir)
    * [`tmp.withTmp`](#with-tmp)
  * Integridad
    * [Subresource Integrity](#integrity)
    * [`verify`](#verify)
    * [`verify.lastRun`](#verify-last-run)

### Ejemplo

```javascript
const cacache = require('cacache')
const fs = require('fs')

const tarball = '/path/to/mytar.tgz'
const cachePath = '/tmp/my-toy-cache'
const key = 'my-unique-key-1234'

// ¬°A√±√°delo al cach√©! Usa `cachePath` como ra√≠z del cach√©.
cacache.put(cachePath, key, '10293801983029384').then(integrity => {
  console.log(`Saved content to ${cachePath}.`)
})

const destination = '/tmp/mytar.tgz'

// Copia el contenido del cach√© a otro fichero, pero esta vez con streams.
cacache.get.stream(
  cachePath, key
).pipe(
  fs.createWriteStream(destination)
).on('finish', () => {
  console.log('done extracting!')
})

// La misma cosa, pero accesando el contenido directamente, sin tocar el √≠ndice.
cacache.get.byDigest(cachePath, integrityHash).then(data => {
  fs.writeFile(destination, data, err => {
    console.log('tarball data fetched based on its sha512sum and written out!')
  })
})
```

### Caracter√≠sticas

* Extracci√≥n por clave o por direcci√≥n de contenido (shasum, etc)
* Usa el est√°ndard de web, [Subresource Integrity](#integrity)
* Compatible con multiples algoritmos - usa sha1, sha512, etc, en el mismo cach√© sin problema
* Entradas con contenido id√©ntico comparten ficheros
* Tolerancia de fallas (inmune a corrupci√≥n, ficheros parciales, carreras de proceso, etc)
* Verificaci√≥n completa de datos cuando (escribiendo y leyendo)
* Concurrencia r√°pida, segura y "lockless"
* Compatible con `stream`s
* Compatible con `Promise`s
* Bastante r√°pida -- acceso, incluyendo verificaci√≥n, en microsegundos
* Almacenaje de metadata arbitraria
* Colecci√≥n de basura y verificaci√≥n adicional fuera de banda
* Cobertura rigurosa de pruebas
* Probablente hay un "Bloom filter" por ah√≠ en alg√∫n lado. Eso le mola a la gente, ¬øVerdad? ü§î

### C√≥mo Contribuir

El equipo de cacache felizmente acepta contribuciones de c√≥digo y otras maneras de participaci√≥n. ¬°Hay muchas formas diferentes de contribuir! La [Gu√≠a de Colaboradores](CONTRIBUTING.md) (en ingl√©s) tiene toda la informaci√≥n que necesitas para cualquier tipo de contribuci√≥n: todo desde c√≥mo reportar errores hasta c√≥mo someter parches con nuevas caracter√≠sticas. Con todo y eso, no se preocupe por si lo que haces est√° ex√°ctamente correcto: no hay ning√∫n problema en hacer preguntas si algo no est√° claro, o no lo encuentras.

El equipo de cacache tiene miembros hispanohablantes: es completamente aceptable crear `issues` y `pull requests` en espa√±ol/castellano.

Todos los participantes en este proyecto deben obedecer el [C√≥digo de Conducta](CODE_OF_CONDUCT.md) (en ingl√©s), y en general actuar de forma amable y respetuosa mientras participan en esta comunidad.

Por favor refi√©rase al [Historial de Cambios](CHANGELOG.md) (en ingl√©s) para detalles sobre cambios importantes inclu√≠dos en cada versi√≥n.

Finalmente, cacache tiene un sistema de localizaci√≥n de lenguaje. Si te interesa a√±adir lenguajes o mejorar los que existen, mira en el directorio `./locales` para comenzar.

Happy hacking!

### API

#### <a name="ls"></a> `> cacache.ls(cache) -> Promise<Object>`

Enumera todas las entradas en el cach√©, dentro de un solo objeto. Cada entrada
en el objeto tendr√° como clave la clave √∫nica usada para el √≠ndice, el valor
siendo un objeto de [`get.info`](#get-info).

##### Ejemplo

```javascript
cacache.ls(cachePath).then(console.log)
// Output
{
  'my-thing': {
    key: 'my-thing',
    integrity: 'sha512-BaSe64/EnCoDED+HAsh=='
    path: '.testcache/content/deadbeef', // joined with `cachePath`
    time: 12345698490,
    size: 4023948,
    metadata: {
      name: 'blah',
      version: '1.2.3',
      description: 'this was once a package but now it is my-thing'
    }
  },
  'other-thing': {
    key: 'other-thing',
    integrity: 'sha1-ANothER+hasH=',
    path: '.testcache/content/bada55',
    time: 11992309289,
    size: 111112
  }
}
```

#### <a name="ls-stream"></a> `> cacache.ls.stream(cache) -> Readable`

Enumera todas las entradas en el cach√©, emitiendo un objeto de [`get.info`](#get-info) por cada evento de `data` en el stream.

##### Ejemplo

```javascript
cacache.ls.stream(cachePath).on('data', console.log)
// Output
{
  key: 'my-thing',
  integrity: 'sha512-BaSe64HaSh',
  path: '.testcache/content/deadbeef', // joined with `cachePath`
  time: 12345698490,
  size: 13423,
  metadata: {
    name: 'blah',
    version: '1.2.3',
    description: 'this was once a package but now it is my-thing'
  }
}

{
  key: 'other-thing',
  integrity: 'whirlpool-WoWSoMuchSupport',
  path: '.testcache/content/bada55',
  time: 11992309289,
  size: 498023984029
}

{
  ...
}
```

#### <a name="get-data"></a> `> cacache.get(cache, key, [opts]) -> Promise({data, metadata, integrity})`

Devuelve un objeto con los datos, digesto de integridad y metadata identificados
por la clave `key`. La propiedad `data` de este objeto ser√° una instancia de
`Buffer` con los datos almacenados en el cach√©.
to do with it! cacache just won't care.

`integrity` es un `string` de [Subresource Integrity](#integrity). D√≠gase, un
`string` que puede ser usado para verificar a la `data`, que tiene como formato
`<hash-algorithm>-<base64-integrity-hash>`.

So no existe ninguna entrada identificada por `key`, o se los datos almacenados
localmente fallan verificaci√≥n, el `Promise` fallar√°.

Una sub-funci√≥n, `get.byDigest`, tiene casi el mismo comportamiento, excepto que
busca entradas usando el hash de integridad, sin tocar el √≠ndice general. Esta
versi√≥n *s√≥lo* devuelve `data`, sin ning√∫n objeto conteni√©ndola.

##### Nota

Esta funci√≥n lee la entrada completa a la memoria antes de devolverla. Si est√°s
almacenando datos Muy Grandes, es posible que [`get.stream`](#get-stream) sea
una mejor soluci√≥n.

##### Ejemplo

```javascript
// Look up by key
cache.get(cachePath, 'my-thing').then(console.log)
// Output:
{
  metadata: {
    thingName: 'my'
  },
  integrity: 'sha512-BaSe64HaSh',
  data: Buffer#<deadbeef>,
  size: 9320
}

// Look up by digest
cache.get.byDigest(cachePath, 'sha512-BaSe64HaSh').then(console.log)
// Output:
Buffer#<deadbeef>
```

#### <a name="get-stream"></a> `> cacache.get.stream(cache, key, [opts]) -> Readable`

Devuelve un [Readable
Stream](https://nodejs.org/api/stream.html#stream_readable_streams) de los datos
almacenados bajo `key`.

So no existe ninguna entrada identificada por `key`, o se los datos almacenados
localmente fallan verificaci√≥n, el `Promise` fallar√°.

`metadata` y `integrity` ser√°n emitidos como eventos antes de que el stream cierre.

Una sub-funci√≥n, `get.stream.byDigest`, tiene casi el mismo comportamiento,
excepto que busca entradas usando el hash de integridad, sin tocar el √≠ndice
general. Esta versi√≥n no emite eventos de `metadata` o `integrity`.

##### Ejemplo

```javascript
// Look up by key
cache.get.stream(
  cachePath, 'my-thing'
).on('metadata', metadata => {
  console.log('metadata:', metadata)
}).on('integrity', integrity => {
  console.log('integrity:', integrity)
}).pipe(
  fs.createWriteStream('./x.tgz')
)
// Outputs:
metadata: { ... }
integrity: 'sha512-SoMeDIGest+64=='

// Look up by digest
cache.get.stream.byDigest(
  cachePath, 'sha512-SoMeDIGest+64=='
).pipe(
  fs.createWriteStream('./x.tgz')
)
```

#### <a name="get-info"></a> `> cacache.get.info(cache, key) -> Promise`

Busca el `key` en el √≠ndice del cach√©, devolviendo informaci√≥n sobre la entrada
si existe.

##### Campos

* `key` - Clave de la entrada. Igual al argumento `key`.
* `integrity` - [Subresource Integrity hash](#integrity) del contenido al que se refiere esta entrada.
* `path` - Direcci√≥n del fichero de datos almacenados, relativa al argumento `cache`.
* `time` - Hora de creaci√≥n de la entrada
* `metadata` - Metadatos asignados a esta entrada por el usuario

##### Ejemplo

```javascript
cacache.get.info(cachePath, 'my-thing').then(console.log)

// Output
{
  key: 'my-thing',
  integrity: 'sha256-MUSTVERIFY+ALL/THINGS=='
  path: '.testcache/content/deadbeef',
  time: 12345698490,
  size: 849234,
  metadata: {
    name: 'blah',
    version: '1.2.3',
    description: 'this was once a package but now it is my-thing'
  }
}
```

#### <a name="get-hasContent"></a> `> cacache.get.hasContent(cache, integrity) -> Promise`

Busca un [Subresource Integrity hash](#integrity) en el cach√©. Si existe el
contenido asociado con `integrity`, devuelve un objeto con dos campos: el hash
_espec√≠fico_ que se us√≥ para la b√∫squeda, `sri`, y el tama√±o total del
contenido, `size`. Si no existe ning√∫n contenido asociado con `integrity`,
devuelve `false`.

##### Ejemplo

```javascript
cacache.get.hasContent(cachePath, 'sha256-MUSTVERIFY+ALL/THINGS==').then(console.log)

// Output
{
  sri: {
    source: 'sha256-MUSTVERIFY+ALL/THINGS==',
    algorithm: 'sha256',
    digest: 'MUSTVERIFY+ALL/THINGS==',
    options: []
  },
  size: 9001
}

cacache.get.hasContent(cachePath, 'sha521-NOT+IN/CACHE==').then(console.log)

// Output
false
```

#### <a name="put-data"></a> `> cacache.put(cache, key, data, [opts]) -> Promise`

Inserta `data` en el cach√©. El `Promise` devuelto se resuelve con un hash
(generado conforme a [`opts.algorithms`](#optsalgorithms)) despu√©s que la
entrada haya sido escrita en completo.

##### Ejemplo

```javascript
fetch(
  'https://registry.npmjs.org/cacache/-/cacache-1.0.0.tgz'
).then(data => {
  return cacache.put(cachePath, 'registry.npmjs.org|cacache@1.0.0', data)
}).then(integrity => {
  console.log('integrity hash is', integrity)
})
```

#### <a name="put-stream"></a> `> cacache.put.stream(cache, key, [opts]) -> Writable`

Devuelve un [Writable
Stream](https://nodejs.org/api/stream.html#stream_writable_streams) que inserta
al cach√© los datos escritos a √©l. Emite un evento `integrity` con el hash del
contenido escrito, cuando completa.

##### Ejemplo

```javascript
request.get(
  'https://registry.npmjs.org/cacache/-/cacache-1.0.0.tgz'
).pipe(
  cacache.put.stream(
    cachePath, 'registry.npmjs.org|cacache@1.0.0'
  ).on('integrity', d => console.log(`integrity digest is ${d}`))
)
```

#### <a name="put-options"></a> `> opciones para cacache.put`

La funciones `cacache.put` tienen un n√∫mero de opciones en com√∫n.

##### `opts.metadata`

Metadatos del usuario que se almacenar√°n con la entrada.

##### `opts.size`

El tama√±o declarado de los datos que se van a insertar. Si es prove√≠do, cacache
verificar√° que los datos escritos sean de ese tama√±o, o si no, fallar√° con un
error con c√≥digo `EBADSIZE`.

##### `opts.integrity`

El hash de integridad de los datos siendo escritos.

Si es prove√≠do, y los datos escritos no le corresponden, la operaci√≥n fallar√°
con un error con c√≥digo `EINTEGRITY`.

`opts.algorithms` no tiene ning√∫n efecto si esta opci√≥n est√° presente.

##### `opts.algorithms`

Por Defecto: `['sha512']`

Algoritmos que se deben usar cuando se calcule el hash de [subresource
integrity](#integrity) para los datos insertados. Puede usar cualquier algoritmo
enumerado en `crypto.getHashes()`.

Por el momento, s√≥lo se acepta un algoritmo (d√≠gase, un array con ex√°ctamente un
valor). No tiene ning√∫n efecto si `opts.integrity` tambi√©n ha sido proveido.

##### `opts.uid`/`opts.gid`

Si est√°n presentes, cacache har√° todo lo posible para asegurarse que todos los
ficheros creados en el proceso de sus operaciones en el cach√© usen esta
combinaci√≥n en particular.

##### `opts.memoize`

Por Defecto: `null`

Si es verdad, cacache tratar√° de memoizar los datos de la entrada en memoria. La
pr√≥xima vez que el proceso corriente trate de accesar los datos o entrada,
cacache buscar√° en memoria antes de buscar en disco.

Si `opts.memoize` es un objeto regular o un objeto como `Map` (es decir, un
objeto con m√©todos `get()` y `set()`), este objeto en s√≠ sera usado en vez del
cach√© de memoria global. Esto permite tener l√≥gica espec√≠fica a tu aplicaci√≥n
encuanto al almacenaje en memoria de tus datos.

Si quieres asegurarte que los datos se lean del disco en vez de memoria, usa
`memoize: false` cuando uses funciones de `cacache.get`.

#### <a name="rm-all"></a> `> cacache.rm.all(cache) -> Promise`

Borra el cach√© completo, incluyendo ficheros temporeros, ficheros de datos, y el
√≠ndice del cach√©.

##### Ejemplo

```javascript
cacache.rm.all(cachePath).then(() => {
  console.log('THE APOCALYPSE IS UPON US üò±')
})
```

#### <a name="rm-entry"></a> `> cacache.rm.entry(cache, key) -> Promise`

Alias: `cacache.rm`

Borra la entrada `key` del √≠nduce. El contenido asociado con esta entrada
seguir√° siendo accesible por hash usando [`get.stream.byDigest`](#get-stream).

Para borrar el contenido en s√≠, usa [`rm.content`](#rm-content). Si quieres
hacer esto de manera m√°s segura (pues ficheros de contenido pueden ser usados
por multiples entradas), usa [`verify`](#verify) para borrar hu√©rfanos.

##### Ejemplo

```javascript
cacache.rm.entry(cachePath, 'my-thing').then(() => {
  console.log('I did not like it anyway')
})
```

#### <a name="rm-content"></a> `> cacache.rm.content(cache, integrity) -> Promise`

Borra el contenido identificado por `integrity`. Cualquier entrada que se
refiera a este contenido quedar√°n hu√©rfanas y se invalidar√°n si se tratan de
accesar, al menos que contenido id√©ntico sea a√±adido bajo `integrity`.

##### Ejemplo

```javascript
cacache.rm.content(cachePath, 'sha512-SoMeDIGest/IN+BaSE64==').then(() => {
  console.log('data for my-thing is gone!')
})
```

#### <a name="set-locale"></a> `> cacache.setLocale(locale)`

Configura el lenguaje usado para mensajes y errores de cacache. La lista de
lenguajes disponibles est√° en el directorio `./locales` del proyecto.

_Te interesa a√±adir m√°s lenguajes? [Somete un PR](CONTRIBUTING.md)!_

#### <a name="clear-memoized"></a> `> cacache.clearMemoized()`

Completamente reinicializa el cach√© de memoria interno. Si est√°s usando tu
propio objecto con `opts.memoize`, debes hacer esto de manera espec√≠fica a √©l.

#### <a name="tmp-mkdir"></a> `> tmp.mkdir(cache, opts) -> Promise<Path>`

Devuelve un directorio √∫nico dentro del directorio `tmp` del cach√©.

Una vez tengas el directorio, es responsabilidad tuya asegurarte que todos los
ficheros escrito a √©l sean creados usando los permisos y `uid`/`gid` concordante
con el cach√©. Si no, puedes pedirle a cacache que lo haga llamando a
[`cacache.tmp.fix()`](#tmp-fix). Esta funci√≥n arreglar√° todos los permisos en el
directorio tmp.

Si quieres que cacache limpie el directorio autom√°ticamente cuando termines, usa
[`cacache.tmp.withTmp()`](#with-tpm).

##### Ejemplo

```javascript
cacache.tmp.mkdir(cache).then(dir => {
  fs.writeFile(path.join(dir, 'blablabla'), Buffer#<1234>, ...)
})
```

#### <a name="with-tmp"></a> `> tmp.withTmp(cache, opts, cb) -> Promise`

Crea un directorio temporero con [`tmp.mkdir()`](#tmp-mkdir) y ejecuta `cb` con
√©l como primer argumento. El directorio creado ser√° removido autom√°ticamente
cuando el valor devolvido por `cb()` se resuelva.

Las mismas advertencias aplican en cuanto a manejando permisos para los ficheros
dentro del directorio.

##### Ejemplo

```javascript
cacache.tmp.withTmp(cache, dir => {
  return fs.writeFileAsync(path.join(dir, 'blablabla'), Buffer#<1234>, ...)
}).then(() => {
  // `dir` no longer exists
})
```

#### <a name="integrity"></a> Digestos de Subresource Integrity

cacache usa strings que siguen la especificaci√≥n de [Subresource Integrity spec](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity).

Es decir, donde quiera cacache espera un argumento o opci√≥n `integrity`, ese
string deber√≠a usar el formato `<hashAlgorithm>-<base64-hash>`.

Una variaci√≥n importante sobre los digestos que cacache acepta es que acepta el
nombre de cualquier algoritmo aceptado por el proceso de Node.js donde se usa.
Puedes usar `crypto.getHashes()` para ver cuales est√°n disponibles.

##### Generando tus propios digestos

Si tienes un `shasum`, en general va a estar en formato de string hexadecimal
(es decir, un `sha1` se ver√≠a como algo as√≠:
`5f5513f8822fdbe5145af33b64d8d970dcf95c6e`).

Para ser compatible con cacache, necesitas convertir esto a su equivalente en
subresource integrity. Por ejemplo, el hash correspondiente al ejemplo anterior
ser√≠a: `sha1-X1UT+IIv2+UUWvM7ZNjZcNz5XG4=`.

Puedes usar c√≥digo as√≠ para generarlo por tu cuenta:

```javascript
const crypto = require('crypto')
const hashAlgorithm = 'sha512'
const data = 'foobarbaz'

const integrity = (
  hashAlgorithm +
  '-' +
  crypto.createHash(hashAlgorithm).update(data).digest('base64')
)
```

Tambi√©n puedes usar [`ssri`](https://npm.im/ssri) para deferir el trabajo a otra
librer√≠a que garantiza que todo est√© correcto, pues maneja probablemente todas
las operaciones que tendr√≠as que hacer con SRIs, incluyendo convirtiendo entre
hexadecimal y el formato SRI.

#### <a name="verify"></a> `> cacache.verify(cache, opts) -> Promise`

Examina y arregla tu cach√©:

* Limpia entradas inv√°lidas, hu√©rfanas y corrompidas
* Te deja filtrar cuales entradas retener, con tu propio filtro
* Reclama cualquier ficheros de contenido sin referencias en el √≠ndice
* Verifica integridad de todos los ficheros de contenido y remueve los malos
* Arregla permisos del cach√©
* Remieve el directorio `tmp` en el cach√©, y todo su contenido.

Cuando termine, devuelve un objeto con varias estad√≠sticas sobre el proceso de
verificaci√≥n, por ejemplo la cantidad de espacio de disco reclamado, el n√∫mero
de entradas v√°lidas, n√∫mero de entradas removidas, etc.

##### Opciones

* `opts.uid` - uid para asignarle al cach√© y su contenido
* `opts.gid` - gid para asignarle al cach√© y su contenido
* `opts.filter` - recibe una entrada como argumento. Devuelve falso para removerla. Nota: es posible que esta funci√≥n sea invocada con la misma entrada m√°s de una vez.

##### Example

```sh
echo somegarbage >> $CACHEPATH/content/deadbeef
```

```javascript
cacache.verify(cachePath).then(stats => {
  // deadbeef collected, because of invalid checksum.
  console.log('cache is much nicer now! stats:', stats)
})
```

#### <a name="verify-last-run"></a> `> cacache.verify.lastRun(cache) -> Promise`

Devuelve un `Date` que representa la √∫ltima vez que `cacache.verify` fue
ejecutada en `cache`.

##### Example

```javascript
cacache.verify(cachePath).then(() => {
  cacache.verify.lastRun(cachePath).then(lastTime => {
    console.log('cacache.verify was last called on' + lastTime)
  })
})
```
